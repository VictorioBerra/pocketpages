<script server>
  const methods = pb().collection('users').listAuthMethods();

  let error = null

  if (request.method === 'POST') {
    dbg(body())
    const {
      identity,
      password,
      mode
    } = body()

    try {
      if (mode === 'password') {
        const user = signInWithPassword(identity, password)
        dbg({
          user
        })
      }
      if (mode === 'anonymous') {
        const user = signInAnonymously()
        dbg({
          user
        })
      }
      redirect(`/`)
    } catch (e) {
      console.error(`**error`, JSON.stringify(e, null, 2))
      error = e.message
    }
  }
</script>
<h2>Login</h2>
<% if (error) { %>
<mark><%= error %></mark>
<% } %>

<% if (methods.password.enabled) { %>
<div>
  <h3>Anonymous Login</h3>
  <form method="post">
    <input type="hidden" name="mode" value="anonymous" />
    <button type="submit">Login</button>
  </form>
</div>
<div>
  <h3>Password Login</h3>
  <form method="post">
    <input type="hidden" name="mode" value="password" />
    <label>Login</label>
    <input name="identity" value="<%= data.identity %>" />
    <label>Password</label>
    <input name="password" type="password" />
    <button type="submit">Login</button>
  </form>
</div>

<% } %>
<div>
  <a href="/auth/forgot">Forgot Password</a>
</div>